name: Deploy buna-jebena

on:
  push:
    branches: [prod]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    #gabubi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Install dependencies (no dev)
        working-directory: ./backend
        run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1

      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Deploy to EC2 via SSM (no SSH)
        env:
          AWS_REGION: us-east-1
          INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

          APP_KEY: ${{ secrets.APP_KEY }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          SES_REGION: ${{ secrets.SES_REGION }}
          MAIL_FROM_ADDRESS: ${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME: ${{ secrets.MAIL_FROM_NAME }}

          MAIL_MAILER: ${{ secrets.MAIL_MAILER }}
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_ENCRYPTION: ${{ secrets.MAIL_ENCRYPTION }}
          MAIL_USERNAME: ${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD: ${{ secrets.MAIL_PASSWORD }}

          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}

          SES_AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          SES_AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          set -euo pipefail

          # Build env content without heredocs (YAML-safe)
          ENV_FILE_CONTENT=""
          ENV_FILE_CONTENT+=$'APP_ENV=production\n'
          ENV_FILE_CONTENT+=$'APP_DEBUG=false\n'
          ENV_FILE_CONTENT+=$'APP_URL=https://api.bunaroots.com\n'
          ENV_FILE_CONTENT+="APP_KEY=${APP_KEY}"$'\n\n'

          ENV_FILE_CONTENT+="DB_HOST=${DB_HOST}"$'\n'
          ENV_FILE_CONTENT+="DB_PORT=${DB_PORT}"$'\n'
          ENV_FILE_CONTENT+="DB_DATABASE=${DB_DATABASE}"$'\n'
          ENV_FILE_CONTENT+="DB_USERNAME=${DB_USERNAME}"$'\n'
          ENV_FILE_CONTENT+="DB_PASSWORD=${DB_PASSWORD}"$'\n\n'

          ENV_FILE_CONTENT+="AWS_ACCESS_KEY_ID=${SES_AWS_ACCESS_KEY_ID}"$'\n'
          ENV_FILE_CONTENT+="AWS_SECRET_ACCESS_KEY=${SES_AWS_SECRET_ACCESS_KEY}"$'\n'
          ENV_FILE_CONTENT+="SES_REGION=${SES_REGION}"$'\n'
          ENV_FILE_CONTENT+="MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}"$'\n'
          ENV_FILE_CONTENT+="MAIL_FROM_NAME=${MAIL_FROM_NAME}"$'\n'
          ENV_FILE_CONTENT+="CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}"$'\n\n'

          ENV_FILE_CONTENT+="MAIL_MAILER=${MAIL_MAILER}"$'\n'
          ENV_FILE_CONTENT+="MAIL_HOST=${MAIL_HOST}"$'\n'
          ENV_FILE_CONTENT+="MAIL_PORT=${MAIL_PORT}"$'\n'
          ENV_FILE_CONTENT+="MAIL_ENCRYPTION=${MAIL_ENCRYPTION}"$'\n'
          ENV_FILE_CONTENT+="MAIL_USERNAME=${MAIL_USERNAME}"$'\n'
          ENV_FILE_CONTENT+="MAIL_PASSWORD=${MAIL_PASSWORD}"$'\n\n'

          ENV_FILE_CONTENT+=$'CACHE_DRIVER=redis\n'
          ENV_FILE_CONTENT+=$'SESSION_DRIVER=redis\n'
          ENV_FILE_CONTENT+=$'QUEUE_CONNECTION=redis\n'
          ENV_FILE_CONTENT+=$'REDIS_HOST=redis\n'
          ENV_FILE_CONTENT+=$'REDIS_PASSWORD=\n'
          ENV_FILE_CONTENT+=$'REDIS_PORT=6379\n'

          ENV_B64=$(printf "%s" "$ENV_FILE_CONTENT" | base64 -w 0)

          COMMAND_ID=$(aws ssm send-command \
            --region "$AWS_REGION" \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE_ID" \
            --comment "Deploy buna-jebena (prod) via SSM" \
            --parameters commands="[
              \"set -euo pipefail\",
              \"sudo mkdir -p /var/www/buna-jebena\",
              \"echo ${ENV_B64} | base64 -d | sudo tee /var/www/buna-jebena/backend/.env > /dev/null\",
              \"cd /var/www\",
              \"if [ ! -d buna-jebena/.git ]; then sudo git clone https://github.com/12thmar/buna-jebena.git buna-jebena; fi\",
              \"cd buna-jebena\",
              \"sudo git config --global --add safe.directory /var/www/buna-jebena\",
              \"sudo git fetch origin prod\",
              \"sudo git reset --hard origin/prod\",
              \"sudo docker-compose -f docker-compose.yml -f docker-compose.prod.yml pull\",
              \"sudo docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build --remove-orphans\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM CommandId: $COMMAND_ID"

          set +e
          aws ssm wait command-executed \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"
          WAIT_RC=$?
          set -e

          aws ssm get-command-invocation \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query '{Status:Status,ResponseCode:ResponseCode,StdOut:StandardOutputContent,StdErr:StandardErrorContent}' \
            --output json

          exit $WAIT_RC
