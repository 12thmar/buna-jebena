name: Deploy buna-jebena

on:
  push:
    branches:
      - prod

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug region
        run: |
          echo "AWS_REGION='${{ secrets.AWS_REGION }}'"

      # Optional local build checks (kept from your workflow)
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          coverage: none

      - name: Install dependencies (no dev)
        working-directory: ./backend
        run: composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: us-east-1
      
      - name: Verify AWS identity
        run: aws sts get-caller-identity

      - name: Deploy to EC2 via SSM (no SSH)
        env:
          AWS_REGION: us-east-1
          INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}

          APP_KEY: ${{ secrets.APP_KEY }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SES_REGION: ${{ secrets.SES_REGION }}

          MAIL_FROM_ADDRESS: ${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME: ${{ secrets.MAIL_FROM_NAME }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
        run: |
          set -euo pipefail

          # Build the .env content here in GitHub, then send it to the server via SSM.
          ENV_FILE_CONTENT=$(cat <<EOF
          APP_ENV=production
          APP_DEBUG=false
          APP_URL=https://api.bunaroots.com
          APP_KEY=${APP_KEY}

          DB_HOST=${DB_HOST}
          DB_DATABASE=${DB_DATABASE}
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}

          MAIL_MAILER=ses
          AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
          AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
          SES_REGION=${SES_REGION}
          MAIL_FROM_ADDRESS=${MAIL_FROM_ADDRESS}
          MAIL_FROM_NAME=${MAIL_FROM_NAME}
          CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}

          CACHE_DRIVER=redis
          SESSION_DRIVER=redis
          QUEUE_CONNECTION=redis
          REDIS_HOST=redis
          REDIS_PASSWORD=
          REDIS_PORT=6379
          EOF
          )

          # Send a single SSM command that:
          # 1) writes /var/www/buna-jebena/.env
          # 2) pulls latest prod
          # 3) restarts containers
          COMMAND_ID=$(aws ssm send-command \
            --region "$AWS_REGION" \
            --document-name "AWS-RunShellScript" \
            --instance-ids "$INSTANCE_ID" \
            --comment "Deploy buna-jebena (prod) via SSM" \
            --parameters commands="[
              \"set -euo pipefail\",
              \"sudo mkdir -p /var/www/buna-jebena\",
              \"sudo bash -lc 'cat > /var/www/buna-jebena/.env <<\\\"ENV\\\"\\n${ENV_FILE_CONTENT}\\nENV'\",
              \"cd /var/www\",
              \"if [ ! -d buna-jebena/.git ]; then sudo git clone https://github.com/12thmar/buna-jebena.git buna-jebena; fi\",
              \"cd buna-jebena\",
              \"sudo git config --global --add safe.directory /var/www/buna-jebena\",
              \"sudo git fetch origin prod\",
              \"sudo git reset --hard origin/prod\",
              \"sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml pull\",
              \"sudo docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d --build --remove-orphans\"
            ]" \
            --query "Command.CommandId" \
            --output text)

          echo "SSM CommandId: $COMMAND_ID"

          aws ssm wait command-executed \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID"

          aws ssm get-command-invocation \
            --region "$AWS_REGION" \
            --command-id "$COMMAND_ID" \
            --instance-id "$INSTANCE_ID" \
            --query '{Status:Status,StdOut:StandardOutputContent,StdErr:StandardErrorContent}' \
            --output json
